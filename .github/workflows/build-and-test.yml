# .github/workflows/scheduled-search.yml

name: Scheduled Naver Search

on:
  schedule:
    - cron: "0 0 * * 0" # 매주 일요일 자정에 실행 (UTC 기준

  # 수동 실행 옵션
  workflow_dispatch:
  inputs:
    mode:
      description: '실행 모드'
      required: true
      default: 'PROD'
      type: choice
      options:
        - PROD
        - DEV
    search_keyword:
      description: '검색 키워드'
      required: true
      default: ''

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # 저장소 내용에 대한 쓰기 권한

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: JDK 설정
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Maven 캐시 설정 (선택 사항)
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Maven 빌드 및 종속성 다운로드
        run: |
            mvn clean compile # Maven을 사용하여 프로젝트 빌드 및 종속성 다운로드

      - name: Application 실행
        env:
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          MODE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode || vars.MODE }}
          SEARCH_KEYWORD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.search_keyword || vars.SEARCH_KEYWORD }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
        run: |
          mvn exec:java -Dexec.mainClass="Application"

      - name: 변경사항 커밋 및 푸시
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "자동 실행 결과 업데이트: ${{ github.workflow }} at $(date +'%Y-%m-%d %H:%M:%S')"
          commit_user_name: ${{ github.repository_owner }}
          commit_user_email: ${{ github.repository_owner }}@users.noreply.github.com
          commit_author: "${{ github.repository_owner }} <${{ github.repository_owner }}@users.noreply.github.com>"
          # 변경된 파일만 커밋
          add_options: '-A'
          # 변경사항이 없으면 아무 작업도 하지 않음
          skip_dirty_check: false
          # GitHub에서 기본 제공하는 토큰 사용
          token: ${{ github.token }}